<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hazelcast Hazelcast Documentation</title>
    <link rel="canonical" href="https://JakeSCahill.github.io/hazelcast/4.1/contribute/extending_hazelcast.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-M267KFN"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','GTM-M267KFN')</script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://JakeSCahill.github.io">Hazelcast Documentation</a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Hazelcast IMDG</a>
            <a class="navbar-item" href="#">Hazelcast Jet</a>
            <a class="navbar-item" href="#">Hazelcast Cloud</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Use cases</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Demos</a>
            <a class="navbar-item" href="#">GitHub</a>
            <a class="navbar-item" href="#">Community</a>
            <a class="navbar-item" href="#">Blog</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="hazelcast" data-version="4.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../hazelcast_overview.html">Hazelcast IMDG</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../hazelcast_overview.html">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../get-started/getting_started.html">Get Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-started/glossary.html">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../develop/hazelcast_clients.html">Develop Solutions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/jcache.html">JCache</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/performance.html">Performance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/serialization.html">Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/striim_cdc.html">Striim Hot Cache</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/transactions.html">Transactions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/distributed_query.html">Distributed Query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/distributed_sql.html">Distributed SQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/distributed_events.html">Distributed Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/distributed_computing.html">Distributed Computing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../deploy/installing_upgrading.html">Deploy Clusters</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/starting_members_clients.html">Starting Members and Clients</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/setting_up_clusters.html">Setting Up Clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/management.html">Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/simulator.html">Hazelcast Simulator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/wan.html">WAN Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deploy/network_partitioning.html">Network Partitioning</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../migrate/migration_guides.html">Migrate</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../troubleshoot/common_exception_types.html">Troubleshooting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../reference/faq.html">Reference</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/dds.html">Distributed data structures</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/system_properties.html">System properties</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/understanding_configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/phone_homes.html">Phone homes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/hazelcast_plugins.html">Plugins</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="extending_hazelcast.html">Contribute</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="licenses.html">Licenses</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="revision_history.html">Documentation changes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Hazelcast IMDG</span>
    <span class="version">4.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Hazelcast IMDG</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../hazelcast_overview.html">4.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Home</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../home/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../home/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../hazelcast_overview.html">Hazelcast IMDG</a></li>
    <li><a href="extending_hazelcast.html">Contribute</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a class="git" href="file:///C:/Users/Jake%20Cahill/Documents/code-playground/docs/hazelcast-docs/modules/contribute/pages/extending_hazelcast.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_extending_hazelcast"><a class="anchor" href="#_extending_hazelcast"></a>Extending Hazelcast</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes the different possibilities to extend Hazelcast with
additional services or features.</p>
</div>
<div class="sect2">
<h3 id="_operationparker"><a class="anchor" href="#_operationparker"></a>OperationParker</h3>
<div class="paragraph">
<p><code>OperationParker</code> is an interface offered by SPI for the objects, such as
Lock and Semaphore, to be used when a thread needs to wait for a lock to be released.</p>
</div>
<div class="paragraph">
<p><code>OperationParker</code> keeps a list of waiters. For each notify operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it looks for a waiter</p>
</li>
<li>
<p>it asks the waiter whether it wants to keep waiting</p>
</li>
<li>
<p>if the waiter responds <strong>no</strong>, the service executes its registered operation (operation itself knows where to send a response)</p>
</li>
<li>
<p>it rinses and repeats until a waiter wants to keep waiting.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each waiter can sit on a wait-notify queue for, at most, its operation&#8217;s call timeout.
For example, by default, each waiter can wait here for at most 1 minute.
A continuous task scans expired/timed-out waiters and invalidates them with <code>CallTimeoutException</code>.
Each waiter on the remote side should retry and keep waiting if it still wants to wait.
This is a liveness check for remote waiters.</p>
</div>
<div class="paragraph">
<p>This way, it is possible to distinguish an unresponsive member and a long (~infinite) wait.
On the caller side, if the waiting thread does not get a response for either
a call timeout or for more than <strong>2 times the call-timeout</strong>, it will exit with
<code>OperationTimeoutException</code>.</p>
</div>
<div class="paragraph">
<p>Note that this behavior breaks the fairness. Hazelcast does not support
fairness for any of the data structures with blocking operations, such as Lock and Semaphore.</p>
</div>
</div>
<div class="sect2">
<h3 id="_discovery_spi"><a class="anchor" href="#_discovery_spi"></a>Discovery SPI</h3>
<div class="paragraph">
<p>By default, Hazelcast is bundled with multiple ways to define and find other members in the same network.
Commonly used, especially with development, is the Multicast discovery.
This sends out a multicast request to a network segment and awaits other members to
answer with their IP addresses. In addition, Hazelcast supports a number of built-in discovery strategies described in
the <a href="#discovery-mechanisms">Discovery Mechanisms</a> section.</p>
</div>
<div class="paragraph">
<p>Since there is an ever growing number of public and private cloud environments,
as well as numerous Service Discovery systems in the wild,
Hazelcast provides cloud or service discovery vendors with the option to
implement their own discovery strategy.</p>
</div>
<div class="paragraph">
<p>Over the course of this section, we will build a simple
discovery strategy based on the <code>/etc/hosts</code> file.</p>
</div>
<div class="sect3">
<h4 id="_discovery_spi_interfaces_and_classes"><a class="anchor" href="#_discovery_spi_interfaces_and_classes"></a>Discovery SPI Interfaces and Classes</h4>
<div class="paragraph">
<p>The Hazelcast Discovery SPI (Member Discovery Extensions) consists of
multiple interfaces and abstract classes. In the following subsections,
we will have a quick look at all of them and shortly introduce the idea and usage behind them.
The example will follow in the next section, <a href="#discovery-strategy">Discovery Strategy</a>.</p>
</div>
<div class="sect4">
<h5 id="_discoverystrategy_implement"><a class="anchor" href="#_discoverystrategy_implement"></a>DiscoveryStrategy: Implement</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.spi.discovery.DiscoveryStrategy</code> interface is
the main entry point for vendors to implement their corresponding member discovery strategies.
Its main purpose is to return discovered members on request.
The <code>com.hazelcast.spi.discovery.DiscoveryStrategy</code> interface also offers
light lifecycle capabilities for setup and teardown logic (for example, opening or closing sockets or REST API clients).</p>
</div>
<div class="paragraph">
<p><code>DiscoveryStrategy</code>s can also do automatic registration / de-registration on
service discovery systems if necessary.
You can use the provided <code>DiscoveryNode</code> that is passed to
the factory method to retrieve local addresses and ports, as well as metadata.</p>
</div>
</div>
<div class="sect4">
<h5 id="_abstractdiscoverystrategy_abstract_class"><a class="anchor" href="#_abstractdiscoverystrategy_abstract_class"></a>AbstractDiscoveryStrategy: Abstract Class</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.spi.discovery.AbstractDiscoveryStrategy</code> is a convenience abstract class meant to
ease the implementation of strategies. It basically provides additional support for
reading / resolving configuration properties and empty implementations of lifecycle methods if unnecessary.</p>
</div>
</div>
<div class="sect4">
<h5 id="_discoverystrategyfactory_factory_contract"><a class="anchor" href="#_discoverystrategyfactory_factory_contract"></a>DiscoveryStrategyFactory: Factory Contract</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.spi.discovery.DiscoveryStrategyFactory</code> interface describes
the factory contract that creates a certain <code>DiscoveryStrategy</code>.
<code>DiscoveryStrategyFactory</code> s are registered automatically at startup of
a Hazelcast member or client whenever they are found in the classpath.
For automatic discovery, factories need to announce themselves as
SPI services using a resource file according to the
<a href="https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html" target="_blank" rel="noopener">Java Service Provider Interface</a>.
The service registration file must be part of the JAR file, located under
<code>META-INF/services/com.hazelcast.spi.discovery.DiscoveryStrategyFactory</code>, and consist of
a line with the full canonical class name of the <code>DiscoveryStrategy</code> per provided strategy implementation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_discoverynode_describe_a_member"><a class="anchor" href="#_discoverynode_describe_a_member"></a>DiscoveryNode: Describe a Member</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.spi.discovery.DiscoveryNode</code> abstract class describes a member in the Discovery SPI.
It is used for multiple purposes, since it will be returned from strategies for discovered members.
It is also passed to <code>DiscoveryStrategyFactory</code>s factory method to define
the local member itself if created on a Hazelcast member; on Hazelcast clients, null is passed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_simplediscoverynode_default_discoverynode"><a class="anchor" href="#_simplediscoverynode_default_discoverynode"></a>SimpleDiscoveryNode: Default DiscoveryNode</h5>
<div class="paragraph">
<p><code>com.hazelcast.spi.discovery.SimpleDiscoveryNode</code> is a default implementation of the <code>DiscoveryNode</code>.
It is meant for convenience use of the Discovery SPI and can be returned from
vendor implementations if no special needs are required.</p>
</div>
</div>
<div class="sect4">
<h5 id="_nodefilter_filter_members"><a class="anchor" href="#_nodefilter_filter_members"></a>NodeFilter: Filter Members</h5>
<div class="paragraph">
<p>You can configure <code>com.hazelcast.spi.discovery.NodeFilter</code> before startup and
you can implement logic to do additional filtering of members.
This might be necessary if query languages for discovery strategies are not
expressive enough to describe members or to overcome inefficiencies of strategy implementations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>DiscoveryStrategy</code> vendor does not need to take possibly configured filters into account
as their use is transparent to the strategies.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_discoveryservice_support_in_integrator_systems"><a class="anchor" href="#_discoveryservice_support_in_integrator_systems"></a>DiscoveryService: Support In Integrator Systems</h5>
<div class="paragraph">
<p>A <code>com.hazelcast.spi.discovery.integration.DiscoveryService</code> is part of the integration domain.
<code>DiscoveryStrategy</code> vendors do not need to implement <code>DiscoveryService</code> because
it is meant to support the Discovery SPI in situations where vendors integrate Hazelcast into
their own systems or frameworks. Certain needs might be necessary as part of the classloading or
<a href="https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html" target="_blank" rel="noopener">Java Service Provider Interface</a> lookup.</p>
</div>
</div>
<div class="sect4">
<h5 id="_discoveryserviceprovider_provide_a_discoveryservice"><a class="anchor" href="#_discoveryserviceprovider_provide_a_discoveryservice"></a>DiscoveryServiceProvider: Provide a DiscoveryService</h5>
<div class="paragraph">
<p>Use the <code>com.hazelcast.spi.discovery.integration.DiscoveryServiceProvider</code> to provide
a <code>DiscoveryService</code> to the Hazelcast discovery subsystem. Configure the provider with the Hazelcast configuration API.</p>
</div>
</div>
<div class="sect4">
<h5 id="_discoveryservicesettings_configure_discoveryservice"><a class="anchor" href="#_discoveryservicesettings_configure_discoveryservice"></a>DiscoveryServiceSettings: Configure DiscoveryService</h5>
<div class="paragraph">
<p>A <code>com.hazelcast.spi.discovery.integration.DiscoveryServiceSettings</code> instance is passed to
the <code>DiscoveryServiceProvider</code> at creation time to configure the <code>DiscoveryService</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_discoverymode_member_or_client"><a class="anchor" href="#_discoverymode_member_or_client"></a>DiscoveryMode: Member or Client</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.spi.discovery.integration.DiscoveryMode</code> enum tells if
a created <code>DiscoveryService</code> is running on a Hazelcast member or client to change the behavior accordingly.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discovery_strategy"><a class="anchor" href="#_discovery_strategy"></a>Discovery Strategy</h4>
<div class="paragraph">
<p>This subsection walks through the implementation of a simple <code>DiscoveryStrategy</code> and its necessary setup.</p>
</div>
<div class="sect4">
<h5 id="_discovery_strategy_example"><a class="anchor" href="#_discovery_strategy_example"></a>Discovery Strategy Example</h5>
<div class="paragraph">
<p>The example strategy uses the local <code>/etc/hosts</code> (and on Windows it uses
the equivalent to the <code>*nix</code> hosts file named <code>%SystemRoot%\system32\drivers\etc\hosts</code>) to
lookup IP addresses of different hosts. The strategy implementation expects hosts to be configured with
hostname sub-groups under the same domain. So far to theory, let&#8217;s get into it.</p>
</div>
<div class="paragraph">
<p>The full example&#8217;s source code can be found <a href="https://github.com/hazelcast/hazelcast-code-samples" target="_blank" rel="noopener">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_site_domain"><a class="anchor" href="#_configuring_site_domain"></a>Configuring Site Domain</h5>
<div class="paragraph">
<p>As a first step we do some basic configuration setup. We want the user to be able to
configure the site domain for the discovery inside the hosts file, therefore we define
a configuration property called <code>site-domain</code>. The configuration is not optional:
you need to configure it before the creation of the <code>HazelcastInstance</code>, either
via Hazelcast&#8217;s declarative or programmatic configuration.</p>
</div>
<div class="paragraph">
<p>It is recommended that you keep all defined properties in a separate configuration class as
public constants (<code>public static final</code>) with sufficient documentation.
This allows users to easily look up possible configuration values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public final class HostsDiscoveryConfiguration {

    public static final PropertyDefinition DOMAIN = new SimplePropertyDefinition("site-domain", PropertyTypeConverter.STRING);

    private HostsDiscoveryConfiguration() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An additional <code>ValueValidator</code> could be passed to the definition to make sure
the configured value looks like a domain or has a special format.</p>
</div>
</div>
<div class="sect4">
<h5 id="_creating_discovery"><a class="anchor" href="#_creating_discovery"></a>Creating Discovery</h5>
<div class="paragraph">
<p>As the second step we create the very simple <code>DiscoveryStrategyFactory</code> implementation class.
To keep things clear we are going to name the discovery strategy after its purpose:
looking into the hosts file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class HostsDiscoveryStrategyFactory implements DiscoveryStrategyFactory {

    private static final Collection&lt;PropertyDefinition&gt; PROPERTIES = singletonList(HostsDiscoveryConfiguration.DOMAIN);

    @Override
    public Class&lt;? extends DiscoveryStrategy&gt; getDiscoveryStrategyType() {
        return HostsDiscoveryStrategy.class;
    }

    @Override
    public DiscoveryStrategy newDiscoveryStrategy(DiscoveryNode discoveryNode, ILogger logger, Map&lt;String, Comparable&gt; properties) {
        return new HostsDiscoveryStrategy(logger, properties);
    }

    @Override
    public Collection&lt;PropertyDefinition&gt; getConfigurationProperties() {
        return PROPERTIES;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This factory now defines properties known to the discovery strategy implementation and
provides a clean way to instantiate it. While creating the <code>HostsDiscoveryStrategy</code> we ignore
the passed <code>DiscoveryNode</code> since this strategy does not support automatic registration of new members.
In cases where the strategy does not support registration, the environment has to handle this in some provided way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember that, when created on a Hazelcast client, the provided <code>DiscoveryNode</code> is null, as there is no
local member in existence.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, we register the <code>DiscoveryStrategyFactory</code> to make Hazelcast pick it up automatically at startup.
As described earlier, this is done according to the
<a href="https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html" target="_blank" rel="noopener">Java Service Provider Interface</a> specification.
The filename is the name of the interface itself. Therefore we create a new resource file called
<code>com.hazelcast.spi.discovery.DiscoveryStrategyFactory</code> and place it under <code>META-INF/services</code>.
The content is the full canonical class name of our factory implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>com.hazelcast.examples.spi.discovery.HostsDiscoveryStrategyFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>If our JAR file contains multiple factories, each consecutive line can define another
full canonical <code>DiscoveryStrategyFactory</code> implementation class name.</p>
</div>
</div>
<div class="sect4">
<h5 id="_implementing_discovery_strategy"><a class="anchor" href="#_implementing_discovery_strategy"></a>Implementing Discovery Strategy</h5>
<div class="paragraph">
<p>Now comes the interesting part. We are going to implement the discovery itself.
The previous parts we did are normally pretty similar for all strategies aside from the configuration properties itself.
However, implementing the discovery heavily depends on the way the strategy has to come up with
IP addresses of other Hazelcast members.</p>
</div>
</div>
<div class="sect4">
<h5 id="_extending_the_abstractdiscoverystrategy"><a class="anchor" href="#_extending_the_abstractdiscoverystrategy"></a>Extending The <code>AbstractDiscoveryStrategy</code></h5>
<div class="paragraph">
<p>For ease of implementation, we back our implementation by extending the <code>AbstractDiscoveryStrategy</code> and
only implementing the absolute minimum ourselves.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class HostsDiscoveryStrategy extends AbstractDiscoveryStrategy {

    private static final String HOSTS_NIX = "/etc/hosts";
    private static final String HOSTS_WINDOWS = "%SystemRoot%\\system32\\drivers\\etc\\hosts";

    private final String siteDomain;

    HostsDiscoveryStrategy(ILogger logger, Map&lt;String, Comparable&gt; properties) {
        super(logger, properties);

        this.siteDomain = getOrNull("discovery.hosts", HostsDiscoveryConfiguration.DOMAIN);
    }

    @Override
    public Iterable&lt;DiscoveryNode&gt; discoverNodes() {
        List&lt;String&gt; assignments = filterHosts();
        return mapToDiscoveryNodes(assignments);
    }

    private List&lt;String&gt; filterHosts() {
        String os = System.getProperty("os.name");

        String hostsPath;
        if (os.contains("Windows")) {
            hostsPath = HOSTS_WINDOWS;
        } else {
            hostsPath = HOSTS_NIX;
        }

        File hosts = new File(hostsPath);


        List&lt;String&gt; lines = readLines(hosts);

        List&lt;String&gt; assignments = new ArrayList&lt;String&gt;();
        for (String line : lines) {

            if (matchesDomain(line)) {
                assignments.add(line);
            }
        }
        return assignments;
    }

    private Iterable&lt;DiscoveryNode&gt; mapToDiscoveryNodes(List&lt;String&gt; assignments) {
        Collection&lt;DiscoveryNode&gt; discoveredNodes = new ArrayList&lt;DiscoveryNode&gt;();

        for (String assignment : assignments) {
            String address = sliceAddress(assignment);
            String hostname = sliceHostname(assignment);

            Map&lt;String, String&gt; attributes = Collections.singletonMap("hostname", hostname);

            InetAddress inetAddress = mapToInetAddress(address);
            Address addr = new Address(inetAddress, NetworkConfig.DEFAULT_PORT);

            discoveredNodes.add(new SimpleDiscoveryNode(addr, attributes));
        }
        return discoveredNodes;
    }

    private List&lt;String&gt; readLines(File hosts) {
        try {
            List&lt;String&gt; lines = new ArrayList&lt;String&gt;();
            BufferedReader reader = new BufferedReader(new FileReader(hosts));

            String line;
            while ((line = reader.readLine()) != null) {
                line = line.trim();
                if (!line.startsWith("#")) {
                    lines.add(line.trim());
                }
            }

            return lines;
        } catch (IOException e) {
            throw new RuntimeException("Could not read hosts file", e);
        }
    }

    private boolean matchesDomain(String line) {
        if (line.isEmpty()) {
            return false;
        }
        String hostname = sliceHostname(line);
        return hostname.endsWith("." + siteDomain);
    }

    private String sliceAddress(String assignment) {
        String[] tokens = assignment.split("\\p{javaSpaceChar}+");
        if (tokens.length &lt; 1) {
            throw new RuntimeException("Could not find ip address in " + assignment);
        }
        return tokens[0];
    }

    private static String sliceHostname(String assignment) {
        String[] tokens = assignment.split("(\\p{javaSpaceChar}+|\t+)+");
        if (tokens.length &lt; 2) {
            throw new RuntimeException("Could not find hostname in " + assignment);
        }
        return tokens[1];
    }

    private InetAddress mapToInetAddress(String address) {
        try {
            return InetAddress.getByName(address);
        } catch (UnknownHostException e) {
            throw new RuntimeException("Could not resolve ip address", e);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_overriding_discovery_configuration"><a class="anchor" href="#_overriding_discovery_configuration"></a>Overriding Discovery Configuration</h5>
<div class="paragraph">
<p>So far our implementation retrieves the configuration property for the <code>site-domain</code>.
Our implementation offers the option to override the value from the configuration
(declarative or programmatic) right from the system environment or JVM properties.
That can be useful when the <code>hazelcast.xml</code> defines a setup for an developer system (like <code>cluster.local</code>) and
operations wants to override it for the real deployment.
By providing a prefix (in this case <code>discovery.hosts</code>) we created an
external property named <code>discovery.hosts.site-domain</code> which can be set as an
environment variable or passed as a JVM property from the startup script.</p>
</div>
<div class="paragraph">
<p>The lookup priority is explained in the following list, priority is from top to bottom:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JVM properties (or under the <code>properties</code> element in <code>hazelcast.xml</code>)</p>
</li>
<li>
<p>System environment</p>
</li>
<li>
<p>Configuration properties</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_implementing_lookup"><a class="anchor" href="#_implementing_lookup"></a>Implementing Lookup</h5>
<div class="paragraph">
<p>Since we have the value for our property now, we can implement the actual lookup and
mapping as already prepared in the <code>discoverNodes</code> method.
The following part is very specific to this special discovery strategy;
for completeness we are showing it anyways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String HOSTS_NIX = "/etc/hosts";
private static final String HOSTS_WINDOWS =
                   "%SystemRoot%\\system32\\drivers\\etc\\hosts";

private List&lt;String&gt; filterHosts() {
    String os = System.getProperty( "os.name" );

    String hostsPath;
    if ( os.contains( "Windows" ) ) {
        hostsPath = HOSTS_WINDOWS;
    } else {
    hostsPath = HOSTS_NIX;
    }

    File hosts = new File( hostsPath );

    // Read all lines
    List&lt;String&gt; lines = readLines( hosts );

    List&lt;String&gt; assignments = new ArrayList&lt;String&gt;();
    for ( String line : lines ) {
        // Example:
        // 192.168.0.1   host1.cluster.local
        if ( matchesDomain( line ) ) {
            assignments.add( line );
        }
    }
    return assignments;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_mapping_to_discoverynode"><a class="anchor" href="#_mapping_to_discoverynode"></a>Mapping to DiscoveryNode</h5>
<div class="paragraph">
<p>After we have collected the address assignments configured in the hosts file,
we can go to the final step and map those to the <code>DiscoveryNode</code>s to return
them from our strategy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private Iterable&lt;DiscoveryNode&gt; mapToDiscoveryNodes( List&lt;String&gt; assignments ) {
  Collection&lt;DiscoveryNode&gt; discoveredNodes = new ArrayList&lt;DiscoveryNode&gt;();

    for ( String assignment : assignments ) {
        String address = sliceAddress( assignment );
        String hostname = sliceHostname( assignment );

        Map&lt;String, Object&gt; attributes =
          Collections.singletonMap( "hostname", hostname );

        InetAddress inetAddress = mapToInetAddress( address );
        Address addr = new Address( inetAddress, NetworkConfig.DEFAULT_PORT );

        discoveredNodes.add( new SimpleDiscoveryNode( addr, attributes ) );
    }
    return discoveredNodes;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that mapping, we now have a full discovery, executed whenever Hazelcast asks for IPs.
So why don&#8217;t we read them in once and cache them?
The answer is simple: it might happen that members go down or come up over time.
Since we expect the hosts file to be injected into the running container,
it also might change over time. We want to get the latest available
members, therefore we read the file on request.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_discoverystrategy"><a class="anchor" href="#_configuring_discoverystrategy"></a>Configuring DiscoveryStrategy</h5>
<div class="paragraph">
<p>To actually use the new <code>DiscoveryStrategy</code> implementation we need to
configure it like in the following example:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;hazelcast&gt;
    ...
    &lt;!-- activate Discovery SPI --&gt;
    &lt;properties&gt;
        &lt;property name="hazelcast.discovery.enabled"&gt;true&lt;/property&gt;
    &lt;/properties&gt;
    &lt;network&gt;
        &lt;join&gt;
            &lt;!-- activate our discovery strategy --&gt;
            &lt;discovery-strategies&gt;

                &lt;!-- class equals to the DiscoveryStrategy not the factory! --&gt;
                &lt;discovery-strategy enabled="true"
                    class="com.hazelcast.examples.spi.discovery.HostsDiscoveryStrategy"&gt;
                    &lt;properties&gt;
                        &lt;property name="site-domain"&gt;cluster.local&lt;/property&gt;
                    &lt;/properties&gt;
                &lt;/discovery-strategy&gt;
            &lt;/discovery-strategies&gt;
        &lt;/join&gt;
    &lt;/network&gt;
    ...
&lt;/hazelcast&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml hljs" data-lang="yml">hazelcast:
  properties:
    hazelcast.discovery.enabled: true
  network:
    join:
      discovery-strategies:
        discovery-strategy:
          - class: com.hazelcast.examples.spi.discovery.HostsDiscoveryStrategy
            enabled: true
            properties:
              site-domain: cluster.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find out further details, please have a look at the
<a href="https://docs.hazelcast.org/docs/4.1/javadoc/com/hazelcast/spi/discovery/package-summary.html">Discovery SPI Javadoc</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discoveryservice_framework_integration"><a class="anchor" href="#_discoveryservice_framework_integration"></a>DiscoveryService (Framework integration)</h4>
<div class="paragraph">
<p>Since the <code>DiscoveryStrategy</code> is meant for cloud vendors or implementors
of service discovery systems, the <code>DiscoveryService</code> is meant for integrators.
In this case, integrators mean people integrating Hazelcast into their own systems or frameworks.
In those situations, there may be special requirements on
how to lookup framework services like the discovery strategies or similar services.
Integrators can extend or implement their own <code>DiscoveryService</code> and
<code>DiscoveryServiceProvider</code> and inject them using the
<code>com.hazelcast.config.DiscoveryConfig</code> configuration API prior to instantiating the <code>HazelcastInstance</code>.
In any case, integrators might have to remember that a <code>DiscoveryService</code> might have to change
behavior based on the runtime environment (Hazelcast member or client) and
then the <code>DiscoveryServiceSettings</code> should provide information about the started <code>HazelcastInstance</code>.</p>
</div>
<div class="paragraph">
<p>Since the implementation heavily depends on one&#8217;s needs,
there is no reason to provide an example of how to implement your own <code>DiscoveryService</code>.
However, Hazelcast provides a default implementation which can be a good example to get started.
This default implementation is <code>com.hazelcast.spi.discovery.impl.DefaultDiscoveryService</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_config_properties_spi"><a class="anchor" href="#_config_properties_spi"></a>Config Properties SPI</h3>
<div class="paragraph">
<p>The Config Properties SPI is an easy way that you can configure
SPI plugins using a prebuilt system of automatic conversion and validation.</p>
</div>
<div class="sect3">
<h4 id="_config_properties_spi_classes"><a class="anchor" href="#_config_properties_spi_classes"></a>Config Properties SPI Classes</h4>
<div class="paragraph">
<p>The Config Properties SPI consists of a small set of classes and provided implementations.</p>
</div>
<div class="sect4">
<h5 id="_propertydefinition_define_a_single_property"><a class="anchor" href="#_propertydefinition_define_a_single_property"></a>PropertyDefinition: Define a Single Property</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.config.properties.PropertyDefinition</code> interface defines
a single property inside a given configuration.
It consists of a key string and type (in form of a <code>com.hazelcast.core.TypeConverter</code>).</p>
</div>
<div class="paragraph">
<p>You can mark properties as optional and you can have an additional validation step to make sure
the provided value matches certain rules (like port numbers must be between 0-65535 or similar).</p>
</div>
</div>
<div class="sect4">
<h5 id="_simplepropertydefinition_basic_propertydefinition"><a class="anchor" href="#_simplepropertydefinition_basic_propertydefinition"></a>SimplePropertyDefinition: Basic PropertyDefinition</h5>
<div class="paragraph">
<p>For convenience, the <code>com.hazelcast.config.properties.SimplePropertyDefinition</code> class is provided.
This class is a basic implementation of the <code>PropertyDefinition</code> interface and should be enough for most situations.
In case of additional needs, you are free to provide your own implementation of the <code>PropertyDefinition</code> interface.</p>
</div>
</div>
<div class="sect4">
<h5 id="_propertytypeconverter_set_of_typeconverters"><a class="anchor" href="#_propertytypeconverter_set_of_typeconverters"></a>PropertyTypeConverter: Set of TypeConverters</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.config.properties.PropertyTypeConverter</code> enum provides a preset of <code>TypeConverter</code>s as listed below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>String</p>
</li>
<li>
<p>Short</p>
</li>
<li>
<p>Integer</p>
</li>
<li>
<p>Long</p>
</li>
<li>
<p>Float</p>
</li>
<li>
<p>Double</p>
</li>
<li>
<p>Boolean</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_valuevalidator_and_validationexception"><a class="anchor" href="#_valuevalidator_and_validationexception"></a>ValueValidator and ValidationException</h5>
<div class="paragraph">
<p>The <code>com.hazelcast.config.properties.ValueValidator</code> interface implements additional value validation.
The configured value will be validated before it is returned to the requester.
If validation fails, a <code>com.hazelcast.config.properties.ValidationException</code> is thrown and
the requester has to handle it or throw the exception further.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_properties_spi_example"><a class="anchor" href="#_config_properties_spi_example"></a>Config Properties SPI Example</h4>
<div class="paragraph">
<p>This sub-section shows a quick example of how to setup, configure and use the Config Properties SPI.</p>
</div>
<div class="sect4">
<h5 id="_defining_a_config_propertydefinition"><a class="anchor" href="#_defining_a_config_propertydefinition"></a>Defining a Config PropertyDefinition</h5>
<div class="paragraph">
<p>Defining a property is as easy as giving it a name and a type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PropertyDefinition property = new SimplePropertyDefinition(
    "my-key", PropertyTypeConverter.STRING
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We defined a property named <code>my-key</code> with a type of a string.
If none of the predefined <code>TypeConverter</code>s matches the need, users are free to provide their own implementation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_providing_a_value_in_xml"><a class="anchor" href="#_providing_a_value_in_xml"></a>Providing a value in XML</h5>
<div class="paragraph">
<p>The above property is now configurable in two ways:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- option 1 --&gt;
&lt;my-key&gt;value&lt;/my-key&gt;

&lt;!-- option 2 --&gt;
&lt;property name="my-key"&gt;value&lt;/property&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In any case, both options are useable interchangeably,
however the later version is recommended by Hazelcast for schema applicability.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_retrieving_a_propertydefinition_value"><a class="anchor" href="#_retrieving_a_propertydefinition_value"></a>Retrieving a PropertyDefinition Value</h5>
<div class="paragraph">
<p>To eventually retrieve a value, use the <code>PropertyDefinition</code> to get and convert the value automatically.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public &lt;T&gt; T getConfig( PropertyDefinition property,
                        Map&lt;String, Comparable&gt; properties ) {

  Map&lt;String, Comparable&gt; properties = ...;
  TypeConverter typeConverter = property.typeConverter();

  Comparable value = properties.get( property.key() );
  return typeConverter.convert( value );
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<link rel="shortcut icon" href="http://hazelcast.com/images/favicon.png">
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/hazelcast/4.1/contribute/extending_hazelcast.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
